
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    

    <title>
Scheduling Your Kubernetes Pods With Elixir | // Álex Go{,5z}
</title>

    
  <meta name="theme-color" content="#ffffff">
  <link rel="stylesheet" href="/static/css/bootstrap.min.css">
  <link rel="stylesheet" href="/static/css/style.css">
  <link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css" rel="stylesheet">

    
    

  <script type="text/javascript">var switchTo5x=true;</script>
  <script type="text/javascript" src="//w.sharethis.com/button/buttons.js"></script>
  <script type="text/javascript">
    stLight.options({publisher: "db740e9c-f490-4a3f-813a-5d257e1ea7f8", doNotHash: false, doNotCopy: false, hashAddressBar: false});
  </script>



    <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
  </head>

  <body>
    
<div class="navbar navbar-default navbar-static-top navbar" role="navigation">
  <div class="container col-md-10 col-md-offset-1 col-lg-8 col-lg-offset-2">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">// Álex Go{,5z}</a>
    </div>
    
    <div class="navbar-collapse collapse">
      
      <ul class="nav navbar-nav">
        
        <li><a href="/archive.html">Archive</a></li>
        

        
        <li><a href="/pages/about.html">About</a></li>
        
        <li><a href="/pages/contact.html">Contact</a></li>
        
      </ul>
      

      
      <ul class="nav navbar-nav navbar-right">
        
        <li class="dropdown">
        <a href="#" data-toggle="dropdown">Categories <b class="caret"></b></a>
        <ul class="dropdown-menu">
          
          
          <li>
          <a href="/category/android.html">android <span class="badge pull-right">1</span></a>
          </li>
          
          
          <li>
          <a href="/category/biz.html">biz <span class="badge pull-right">1</span></a>
          </li>
          
          
          <li>
          <a href="/category/blog.html">blog <span class="badge pull-right">5</span></a>
          </li>
          
          
          <li>
          <a href="/category/dev.html">dev <span class="badge pull-right">6</span></a>
          </li>
          
          
          <li>
          <a href="/category/devops.html">devops <span class="badge pull-right">5</span></a>
          </li>
          
          
          <li>
          <a href="/category/gnome.html">gnome <span class="badge pull-right">2</span></a>
          </li>
          
          
          <li>
          <a href="/category/go.html">go <span class="badge pull-right">3</span></a>
          </li>
          
          
          <li>
          <a href="/category/kubernetes.html">kubernetes <span class="badge pull-right">1</span></a>
          </li>
          
          
          <li>
          <a href="/category/linux.html">linux <span class="badge pull-right">1</span></a>
          </li>
          
          
          <li>
          <a href="/category/security.html">security <span class="badge pull-right">1</span></a>
          </li>
          
          
          <li>
          <a href="/category/spacemacs.html">spacemacs <span class="badge pull-right">2</span></a>
          </li>
          
          
          <li>
          <a href="/category/talks.html">talks <span class="badge pull-right">15</span></a>
          </li>
          
          
          <li>
          <a href="/category/vim.html">vim <span class="badge pull-right">1</span></a>
          </li>
          
        </ul>
        </li>
        
      </ul>
      
    </div>
    
  </div>
</div>

    
<div class="container col-md-10 col-md-offset-1 col-lg-8 col-lg-offset-2">
  <h1>Scheduling Your Kubernetes Pods With Elixir</h1>

  <p>
    
    <span class="label label-default">by Álex</span>

    
    <span class="label label-default">2017-01-16</span>
    

    
    <a class="label label-success" href="/category/kubernetes.html">kubernetes</a>
    

    
    
    <a class="label label-info" href="/tag/elixir.html">elixir</a>
    
    <a class="label label-info" href="/tag/scheduler.html">scheduler</a>
    
    <a class="label label-info" href="/tag/kubernetes.html">kubernetes</a>
    
    
  </p>

  <blockquote>
<p>This was originally posted on <a href="https://deis.com/blog/2016/scheduling-your-kubernetes-pods-with-elixir/">deis.com</a>.</p>
</blockquote>

<p><a href="https://twitter.com/kelseyhightower">Kelsey Hightower</a> gave a really interesting talk at <a href="https://skillsmatter.com/conferences/7208-containersched-2015">ContainerSched</a> about how to create your own scheduler using the Kubernetes HTTP API.</p>

<p>The talk was awesome. It&rsquo;s incredible to see what kind of things you can do with a base system as good as Kubernetes.</p>

<p>However, I missed one thing. The <a href="https://github.com/kelseyhightower/scheduler">example</a> provided by Kelsey was a Go application. Which is the main language used with Kubernetes. So, if you look at that code without any context, you might think it&rsquo;s using some kind of Kubernetes internal packages. But it&rsquo;s not! It&rsquo;s a standalone piece of code that happens to make some HTTP calls.</p>

<p>To illustrate this point, I decided to write my own scheduler, in a different language. In my case, <a href="http://elixir-lang.org/">Elixir</a>, because that&rsquo;s the language I happen to be learning at the moment.</p>

<p>This post isn&rsquo;t an intro to Elixir, but the code should be easy to follow.</p>

<p>Also, I&rsquo;m going to use <code>localhost</code> when accessing the Kubernetes API. Why? For simplicity. If we run <code>kubectl proxy</code> on a computer connected to the Kubernetes master, we will not need to deal with authorization, hosts, and so on. The <code>proxy</code> command will do it for us.</p>

<p>So, let&rsquo;s dive in.</p>

<h2>Get a List of Unscheduled Jobs</h2>

<p>To start off with, we need a pod for our scheduler to schedule.</p>

<p>By default, Kubernetes will schedule all your pods. So, we need to create a unscheduled pod and we need to indicate to Kubernetes that we don&rsquo;t want our pod to get scheduled.</p>

<p>So, create a file called <code>pod.yml</code> and put this inside:</p>

<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  name: custom
  annotations:
    scheduler.alpha.kubernetes.io/name: myOwnScheduler
spec:
  containers:
    - name: &quot;nginx&quot;
      image: &quot;nginx:1.10.0&quot;
</code></pre>

<p>Notice the <code>scheduler.alpha.kubernetes.io/name</code> annotation we use to specify that our scheduler (that we call <code>myOwnScheduler</code>) will be handling this pod.</p>

<p>Now, let&rsquo;s create the pod from the definition file:</p>

<pre><code class="language-bash">kubectl create -f pod.yml
</code></pre>

<p>After you&rsquo;ve done this, there will be an unscheduled job waiting for us inside Kubernetes. Why unscheduled? Because our pod says it wants to be scheduled by the <code>myOwnScheduler</code> scheduler, but we&rsquo;ve not created it yet, so Kubernetes can&rsquo;t schedule it.</p>

<p>So, let&rsquo;s build our scheduler.</p>

<p>First, our scheduler must be able to grab this unscheduled job from the API.</p>

<p>Here&rsquo;s the function I wrote to do that:</p>

<pre><code class="language-elixir">def unscheduled_pods do
  is_managed_by_us = &amp;(get_in(&amp;1, [&quot;metadata&quot;, &quot;annotations&quot;, &quot;scheduler.alpha.kubernetes.io/name&quot;]) == @name)

  resp = HTTPoison.get! &quot;http://127.0.0.1:8001/api/v1/pods?fieldSelector=spec.nodeName=&quot;
  resp.body
  |&gt; Poison.decode!
  |&gt; get_in([&quot;items&quot;])
  |&gt; Enum.filter(is_managed_by_us)
  |&gt; Enum.map(&amp;(get_in(&amp;1, [&quot;metadata&quot;, &quot;name&quot;])))
end
</code></pre>

<p>As you can see we are using <code>127.0.0.1</code> to query our API, this is posible thanks to the <code>kubectl proxy</code> command we mentioned in the intro.</p>

<p>This code grabs the name of all the pods that are waiting to be scheduled inside Kubernetes. It then uses the <code>is_managed_by_us</code> function to see whether the <code>@name</code> attribute is set to <code>myOwnScheduler</code>. If this is true, the pod has indicated that it should be managed by our scheduler.</p>

<h2>An Elixir Introduction</h2>

<p>I said I wouldn&rsquo;t explain Elixir, but I will just comment on three piece of syntax.</p>

<p>The <code>|&gt;</code> in the code above is a pipe, like the <code>|</code> character from a shell script. Using this passes the result from the left side as a parameter to the function on the right side. In this way return values can be piped through functions.</p>

<p>The <code>&amp;</code> character marks an <a href="https://en.wikipedia.org/wiki/Anonymous_function">anonymous function</a>, i.e. a function that we define inline as an expression. And <code>&amp;1</code> refers the first parameter received by the function.</p>

<p>We can also use an anonymous function as parameter to another function. As we are doing, in the <code>map</code> call.</p>

<h2>Get a List of Available Nodes</h2>

<p>Our <code>unscheduled_pods</code> function gets us a list of pods that have not been scheduled yet. So next up, we can bind them to our nodes. That is, we tell our containers to run on particular nodes.</p>

<p>But wait, how do we know what nodes are available?</p>

<p>We&rsquo;ll need to grab those as well, like this:</p>

<pre><code class="language-elixir">def nodes do
  resp = HTTPoison.get! &quot;http://127.0.0.1:8001/api/v1/nodes&quot;
  resp.body
  |&gt; Poison.decode!
  |&gt; get_in([&quot;items&quot;])
  |&gt; Enum.map(&amp;(get_in(&amp;1, [&quot;metadata&quot;, &quot;name&quot;])))
end
</code></pre>

<p>This code will return a list of all nodes.</p>

<p>We could potentially request a lot more information from the API at this point, but for what we&rsquo;re building, it&rsquo;s not necessary. If you want to now what extra information is available, <a href="http://kubernetes.io/kubernetes/third_party/swagger-ui/#!/api%2Fv1/listNamespacedNode">check the documentation for this endpoint</a>.</p>

<h2>The Bind Function</h2>

<p>So let&rsquo;s review.</p>

<p>We have a list of all the unscheduled jobs that we are supposed to manage. And we have a list of all the nodes we can schedule jobs to.</p>

<p>But how do we actually schedule a pods on a node?</p>

<p>We call the bind endpoint, like this:</p>

<pre><code class="language-elixir">def bind(pod_name, node_name) do
  url = &quot;http://127.0.0.1:8001/api/v1/namespaces/default/pods/#{pod}/binding&quot;
  payload = %{
    &quot;apiVersion&quot;: &quot;v1&quot;,
    &quot;kind&quot;: &quot;Binding&quot;,
    &quot;metadata&quot;: %{
      &quot;name&quot;: pod_name,
    },
    &quot;target&quot;: %{
      &quot;apiVersion&quot;: &quot;v1&quot;,
      &quot;kind&quot;: &quot;Node&quot;,
      &quot;name&quot;: node_name,
    }
  }
  headers = [{'content-type', 'application/json'}]

  HTTPoison.post! url, payload |&gt; Poison.encode!, headers
  IO.puts &quot;#{pod_name} pod scheduled in #{node_name}&quot;
end
</code></pre>

<p>But before we can use this function, we need a scheduling strategy.</p>

<h2>Scheduling Strategy</h2>

<p>For our simple scheduler, we will go with a random scheduling strategy.</p>

<p>In effect, we schedule each pod on a random node. Multiple pods might even end up on the same node.</p>

<p>Here&rsquo;s how we do that:</p>

<pre><code class="language-elixir">def schedule(pods) do
  pods
  |&gt; Enum.each(&amp;(bind(&amp;1, Enum.random(nodes))))
end
</code></pre>

<p>Of course, this is very basic, and there are much better ways to maximise the resources we have available to us. But we&rsquo;re building this as a learning exercise. Feel free to extend this code if you want to take things further.</p>

<p>Some ideas to get you going:</p>

<ul>
<li><a href="https://en.wikipedia.org/wiki/Round-robin_scheduling">Round-robin</a> pod scheduling.</li>
<li>Implement your own version of Kubernete&rsquo;s load-aware scheduling.</li>
<li>Annotate the pods with some extra information, for example: cluster.type: raspberry if you want to send them to the Raspberry Pi nodes in your cluster.</li>
<li>You could use some external source of truth, e.g. Nagios, to determine which nodes to schedule jobs on.</li>
</ul>

<h2>Putting Everything Together</h2>

<p>Now we have everything in place, a <code>main</code> function is all that&rsquo;s needed:</p>

<pre><code class="language-elixir">def main(_args) do
  unscheduled_pods
  |&gt; schedule
end
</code></pre>

<p>Now you are able to run your program!</p>

<p>A simple <code>elixir your_script.exs</code> should do it, if you have all the dependencies. But you probably don&rsquo;t, so I recommend you follow the Usage section in <a href="https://github.com/agonzalezro/escheduler#usage">the README</a> for the code that accompanies this post.</p>

<h2>Wrap Up</h2>

<p>For a most things, you probably don&rsquo;t want to write your own scheduler. The one provided by Kubernetes is good for so many things.</p>

<p>But if you want to do something the default Kubernetes scheduler can&rsquo;t do, it&rsquo;s not as difficult as you might think to write your own and slot it in, and continue to take advantage of everything Kubernetes has to offer.</p>

<p>I&rsquo;ve put my code up for <a href="https://github.com/agonzalezro/escheduler">my Elixir scheduler</a>, on GitHub in case you want to check it out. This repository has everything you need to follow along with this post, from the YAML pod definition to the scheduler itself.</p>


  

<br>
<span class='st_sharethis_large' displayText='ShareThis'></span>
<span class='st_facebook_large' displayText='Facebook'></span>
<span class='st_twitter_large' displayText='Tweet'></span>
<span class='st_linkedin_large' displayText='LinkedIn'></span>
<span class='st_googleplus_large' displayText='Google +'></span>
<span class='st_reddit_large' displayText='Reddit'></span>
<span class='st_email_large' displayText='Email'></span>


  

<h2>Comments</h2>
<div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = 'agonzalezro';
  // TODO (agonzalezro): Compatibility with my old blog articles
  // I don't know if it will work for other users
  var disqus_identifier = 'scheduling-your-kubernetes-pods-with-elixir.html';

  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


</div>


    
<div class="container col-md-10 col-md-offset-1 col-lg-8 col-lg-offset-2">
  <div class="text-center">
    <p>
      <a href="http://github.com/agonzalezro/polo">polo</a> is made with
      <span class="glyphicon glyphicon-heart"></span> by
      <a href="http://twitter.com/agonzalezro">@agonzalezro</a>
    </p>
  </div>
</div>

    
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script src="//getbootstrap.com/dist/js/bootstrap.min.js"></script>

    

  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-35984509-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
  

  </body>
</html>
